<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Software Genlock: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Software Genlock
   &#160;<span id="projectnumber">v3.0.0</span>
   </div>
   <div id="projectbrief">Digital Signage SW Library for adjusting VSYNC timings via MMIO PLL register modifications.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Software Genlock Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> <a href="https://api.securityscorecards.dev/projects/github.com/intel-retail/automated-vending"><img src="https://api.securityscorecards.dev/projects/github.com/intel-retail/automated-vending/badge" alt="OpenSSF Scorecard" class="inline"/></a></p>
<p>Copyright (C) 2023 Intel Corporation SPDX-License-Identifier: MIT</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Introduction SW Genlock</h1>
<p>SW Genlock is a software solution designed to synchronize the display outputs of multiple computer systems to single digit microsecond precision, enabling seamless visual outputs across an array of screens. This technology is particularly beneficial in settings that require highly synchronized video outputs, such as video walls, virtual reality setups, digital signage, and other multi-display configurations.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Key Features of SW Genlock</h2>
<ul>
<li><b>High Precision Synchronization</b>: Ensures that vertical sync (vblank) intervals occur simultaneously across all connected systems, maintaining the integrity of visual displays.</li>
<li><b>Flexible Integration</b>: Offers both dynamic (.so) and static (.a) linking options to accommodate various application needs.</li>
<li><b>Comprehensive Tools</b>: Includes a suite of tools and libraries that facilitate the synchronization process, such as obtaining vblank timestamps and adjusting the phase-locked loop (PLL) frequencies.</li>
<li><b>Extensive Compatibility</b>: Supports systems equipped with Precision Time Protocol (PTP), allowing for precise clock synchronization over network infrastructures.</li>
<li><b>User-Centric Utilities</b>: Provides reference applications that demonstrate effective usage of the library, assisting users in integrating Genlock capabilities into their own projects.</li>
</ul>
<p>The SW Genlock system operates by aligning the internal clocks of all systems involved, ensuring that every display refresh is triggered simultaneously. This alignment is achieved through the utilization of industry-standard protocols and our advanced proprietary algorithms, which manage the synchronization over ethernet or direct network connections.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Known Issues</h2>
<p>Users of this SW Genlock libraries may need to adjust the value for SHIFT. In testing, on various displays a valaue that is too large can cause flickering on screen when synchronized. To resolve this, adjust the value of SHIFT. The adjustment can be made by:</p>
<p>1) Editing the default value in <a href="./lib/common.h">lib/common.h</a> 2) Providing a new value for SHIFT when running the sample application:</p>
<div class="fragment"><div class="line">synctest -s &lt;shift_value&gt;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md18"></a>
Installation</h1>
<p>Installing SW Genlock involves a few straightforward steps. This section guides through the process of setting up SW Genlock on target systems, ensuring that user have everything needed to start synchronizing displays.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
System Requirements</h2>
<p>Before the user begin the installation, ensure the systems meet the following criteria:</p>
<p>The build system assumes the following, prior to executing the build steps:</p>
<p>1) The system has an <a href="https://ubuntu.com/tutorials/install-ubuntu-desktop#1-overview">Ubuntu OS</a> 1) Libraries installed: <code>sudo apt install -y git build-essential make</code> 1) <a href="https://wiki.ubuntu.com/UEFI/SecureBoot/DKMS">Disable secure boot</a> 1) MUST apply the <a href="./resources/0001-dpll-Provide-a-command-line-param-to-config-if-PLLs-.patch">PLL kernel patch</a>. Compile the kernel and update either the entire kernel or just the i915.ko module, depending on the Linux configuration. Note: In some setups, the i915.ko module is integrated into the initrd.img, and updating it in /lib/module/... might not reflect the changes.</p><ul>
<li>Following the application of the patch, edit the grub settings: <div class="fragment"><div class="line">sudo vi /etc/grub/default</div>
<div class="line"># add i915.share_dplls=0 to the GRUB_CMDLINE_LINUX options:</div>
<div class="line"># GRUB_CMDLINE_LINUX=&quot;i915.share_dplls=0&quot;</div>
<div class="line"># Save and exit, then update grub</div>
<div class="line">update-grub</div>
</div><!-- fragment --></li>
</ul>
<p>1) Apply <b><a href="./resources/0001-Revert-drm-vblank-remove-drm_timestamp_monotonic-par.patch">the monotonic timstamp patch</a></b> to Linux kernel i915 driver which allows it to provide vsync timestamps in real time instead of the default monotonic time.<br  />
 Note that the monotonic timestamp patch is generated based on Linux v6.4 and has been tested on Linux v6.4 and v6.5.<br  />
 Please follow the steps to disable monotonic timestamp after installing the local built Linux image on a target. Compile the kernel and update either the entire kernel or just the drm.ko module based on the installed Linux configuration. <br  />
</p><ol type="1">
<li>Add <code>drm.timestamp_monotonic=0</code> option to <b>GRUB_CMDLINE_LINUX</b> in /etc/default/grub</li>
<li>Update <b>GRUB_DEFAULT</b> in /etc/default/grub to address the local built Linux image</li>
<li>Run <code>update-grub</code> to apply the change</li>
<li><p class="startli">Reboot a target 1) Turn off NTP time synchronization service by using this command: </p><div class="fragment"><div class="line">1) All the involved systems must support PTP time synchronization via ethernet (e.g ptp4l, phc2sys)</div>
<div class="line">   To verify if an ethernet interface supports PTP, the `ethtool` linux tool can be used. Run the following command, replacing `eth0` with the relevant interface name:</div>
<div class="line"> </div>
<div class="line">   ```console</div>
<div class="line">   ethtool -T eth0</div>
</div><!-- fragment --><p class="startli">If the interface supports PTP, the output will display specific PTP hardware clock information. To ensure proper synchronization, the Ethernet interfaces on the involved systems should be directly connected either via a crossover cable or through a PTP-supported router or switch. If the systems only have a single network interface, it may be necessary to add a separate network adapter, such as a USB-to-Ethernet or USB-to-WiFi dongle, to maintain SSH access and connectivity to external networks. 1) Displays must be at same refresh rate (e.g 60Hz)</p>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md20"></a>
Build steps</h2>
<p>1) Git clone this repository 1) <code>sudo apt install libdrm-dev libpciaccess-dev</code> 1) If the directory /usr/include/drm does not exist, it may be necessary to run the command<code>sudo apt install -y linux-libc-dev</code> 2) Type <code>make</code> from the main directory. It compiles everything and creates library and executable binaries in respective folders along with code which can then be copied to the target systems.</p>
<h1><a class="anchor" id="autotoc_md21"></a>
Software Components</h1>
<h2><a class="anchor" id="autotoc_md22"></a>
Vsync Library</h2>
<p>The Vsync library is distributed in both dynamic (.so) and static (.a) binary formats, allowing users to choose between dynamic and static linking depending on their application requirements. This library includes essential functions such as retrieving vblank timestamps and adjusting the vblank timestamp drift by specified microseconds. Additionally, all operations related to Phase-Locked Loop (PLL) programming are encapsulated within the library, providing a comprehensive suite of tools for managing display synchronization.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Reference Applications</h2>
<p>Accompanying the library, three reference applications are provided to demonstrate how to utilize the library effectively. These include:</p>
<ul>
<li>A <code>vsync test</code> app that runs in either primary mode or secondary mode. primary mode is run on a single PC whereas all other PCs are run as secondary mode with parameters pointing to primary mode system ethernet address. The communication is done either in ethernet mode or IP address mode.</li>
</ul>
<div class="fragment"><div class="line">Usage: ./vsync_test [-m mode] [-i interface] [-c mac_address] [-d delta] [-p pipe] [-s shift] [-v loglevel] [-h]</div>
<div class="line">Options:</div>
<div class="line">  -m mode        Mode of operation: pri, sec (default: pri)</div>
<div class="line">  -i interface   Network interface to listen on (primary) or connect to (secondary) (default: 127.0.0.1)</div>
<div class="line">  -c mac_address MAC address of the network interface to connect to. Applicable to ethernet interface mode only.</div>
<div class="line">  -d delta       Drift time in microseconds to allow before pll reprogramming (default: 100 us)</div>
<div class="line">  -p pipe        Pipe to get stamps for.  4 (all) or 0,1,2 ... (default: 0)</div>
<div class="line">  -s shift       PLL frequency change fraction (default: 0.1)</div>
<div class="line">  -v loglevel    Log level: error, warning, info, debug or trace (default: info)</div>
<div class="line">  -h             Display this help message</div>
</div><!-- fragment --><ul>
<li>A <code>vbltest</code> app to print average vblank period between sync. This is useful in verification and validation.</li>
</ul>
<div class="fragment"><div class="line">[INFO] Vbltest Version: 2.0.0</div>
<div class="line"> Usage: ./vbltest [-p pipe] [-c vsync_count] [-v loglevel] [-h]</div>
<div class="line"> Options:</div>
<div class="line">  -p pipe        Pipe to get stamps for.  0,1,2 ... (default: 0)</div>
<div class="line">  -c vsync_count Number of vsyncs to get timestamp for (default: 300)</div>
<div class="line">  -v loglevel    Log level: error, warning, info, debug or trace (default: info)</div>
<div class="line">  -h             Display this help message</div>
</div><!-- fragment --><ul>
<li>A <code>synctest</code> app to drift vblank clock on a single display by certain period such as 1000 microseconds (or 1.0 ms).</li>
</ul>
<div class="fragment"><div class="line">[INFO] Synctest Version: 2.0.0</div>
<div class="line">Usage: ./synctest [-p pipe] [-d delta] [-s shift] [-v loglevel] [-h]</div>
<div class="line">Options:</div>
<div class="line">-p pipe        Pipe to get stamps for.  0,1,2 ... (default: 0)</div>
<div class="line">-d delta       Drift time in us to achieve (default: 1000 us) e.g 1000 us = 1.0 ms</div>
<div class="line">-s shift       PLL frequency change fraction (default: 0.1)</div>
<div class="line">-v loglevel    Log level: error, warning, info, debug or trace (default: info)</div>
<div class="line">-h             Display this help message</div>
</div><!-- fragment --><p><b>synctest sample output:</b></p>
<div class="fragment"><div class="line">./synctest</div>
<div class="line">[INFO] Synctest Version: 2.0.0</div>
<div class="line">[INFO] DRM Info:</div>
<div class="line">[INFO]   CRTCs found: 4</div>
<div class="line">[INFO]    Pipe:  0, CRTC ID:   80, Mode Valid: Yes, Mode Name: , Position: (   0,    0), Resolution: 1920x1080, Refresh Rate: 60.00 Hz</div>
<div class="line">[INFO]    Pipe:  1, CRTC ID:  131, Mode Valid:  No, Mode Name: , Position: (   0,    0), Resolution:    0x0   , Refresh Rate: 0.00 Hz</div>
<div class="line">[INFO]    Pipe:  2, CRTC ID:  182, Mode Valid:  No, Mode Name: , Position: (   0,    0), Resolution:    0x0   , Refresh Rate: 0.00 Hz</div>
<div class="line">[INFO]    Pipe:  3, CRTC ID:  233, Mode Valid:  No, Mode Name: , Position: (   0,    0), Resolution:    0x0   , Refresh Rate: 0.00 Hz</div>
<div class="line">[INFO]   Connectors found: 6</div>
<div class="line">[INFO]    Connector: 0    (ID: 236 ), Type: 11   (HDMI-A      ), Type ID: 1   , Connection: Disconnected</div>
<div class="line">[INFO]    Connector: 1    (ID: 246 ), Type: 11   (HDMI-A      ), Type ID: 2   , Connection: Connected</div>
<div class="line">[INFO]    Encoder ID: 245, CRTC ID: 80</div>
<div class="line">[INFO]    Connector: 2    (ID: 250 ), Type: 10   (DisplayPort ), Type ID: 1   , Connection: Disconnected</div>
<div class="line">[INFO]    Connector: 3    (ID: 259 ), Type: 11   (HDMI-A      ), Type ID: 3   , Connection: Disconnected</div>
<div class="line">[INFO]    Connector: 4    (ID: 263 ), Type: 10   (DisplayPort ), Type ID: 2   , Connection: Disconnected</div>
<div class="line">[INFO]    Connector: 5    (ID: 272 ), Type: 10   (DisplayPort ), Type ID: 3   , Connection: Disconnected</div>
<div class="line">[INFO] VBlank interval before starting synchronization: 16.667000 ms</div>
<div class="line">[INFO] VBlank interval during synchronization -&gt;</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6650 ms</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6650 ms</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6650 ms</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6650 ms</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6640 ms</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6650 ms</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6650 ms</div>
<div class="line">[INFO]   VBlank interval on pipe 0 is 16.6660 ms</div>
<div class="line">[INFO] VBlank interval after synchronization ends: 16.667000 ms</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md24"></a>
Generating Doxygen documents</h1>
<p>Please install doxygen and graphviz packages before generating Doxygen documents: </p><div class="fragment"><div class="line">1. Type ```make doxygen VERSION=&quot;1.2.3&quot;``` from the main directory. It will generate SW Genlock doxygen documents</div>
<div class="line"> to output/doxygen folder. Change the version to be that of the release number for the project.</div>
<div class="line">2. Open output/doxygen/html/index.html with a web-browser</div>
<div class="line"> </div>
<div class="line"># Running on single system</div>
<div class="line"> </div>
<div class="line">The reference applications vbltest and synctest are designed to operate on a single system. The vbltest app displays the average vblank period for a specific pipe, while synctest allows user to introduce a specific drift in the vblank timing for a pipe. Synctest serves as a practical tool to verify the effectiveness of the synchronization methodology.</div>
<div class="line"> </div>
<div class="line">1) On the system, go to the directory where these files exist and set environment variable:</div>
<div class="line">2) For dynamic linking with the .so library, it&#39;s necessary to set the LD_LIBRARY_PATH environment variable so that applications can locate the vsync dynamic library. This step is not required when using static linking.</div>
<div class="line"> </div>
<div class="line">```console</div>
<div class="line">export LD_LIBRARY_PATH=`pwd`/lib</div>
<div class="line">``````</div>
<div class="line"> </div>
<div class="line">3) On the primary system, run accompanied reference apps as follows:</div>
<div class="line">4) e.g synctest</div>
<div class="line"> ```console</div>
<div class="line">   ./synctest</div>
</div><!-- fragment --><p>Building of this program has been successfully tested on both Ubuntu 2x and Fedora 30.<br  />
</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Synchronization between two systems</h1>
<p>Synchronizing displays across two systems involves a two-step process. Firstly, the Real Time Clocks of both systems need to be kept in synchronized state using the ptp4l Linux tool. Subsequently, the vsync test app should be run in primary mode on one system and in secondary mode on the other, ensuring that the vblank of the secondary system remains synchronized with that of the primary system.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Synchronizing Clocks between two systems</h2>
<p>The SW Genlock feature requires that all participating systems' clocks be synchronized to the nanosecond level. Kernel patches included with the software return vblank timestamps based on the system clock rather than the kernel's monotonic clock, which tracks time from when the kernel is loaded. Accurate synchronization is crucial because SW Genlock shares vblank timestamps from the primary system with secondary systems. This synchronization is achieved using the Linux ptp4l tool. There should be a network cable directly connecting the ethernet ports of the two systems.</p>
<h3><a class="anchor" id="autotoc_md27"></a>
Clock Configuration in PTP-Supported Systems</h3>
<p>Systems supporting PTP typically have two clocks: the system's real-time clock and another clock on the Ethernet card. The synchronization process involves:</p>
<ol type="1">
<li><b>Primary System Real-Time Clock Synchronization</b>:<ul>
<li>Initially synchronize the primary system's real-time clock with an NTP server.</li>
<li>Then sync the Ethernet PTP clock with the primary system's real-time clock.</li>
</ul>
</li>
<li><b>Secondary Systems Synchronization</b>:<ul>
<li>Sync the secondary systems' Ethernet PTP clocks with the primary's Ethernet PTP clock.</li>
<li>Sync their system real-time clocks with their Ethernet PTP clocks, which are already synchronized with the primary system.</li>
</ul>
</li>
</ol>
<p>This setup ensures all secondary system's real-time clocks are synchronized with the primary system's real-time clock. Synchronization within a system (system real-time clock to Ethernet PTP clock) is managed using the <code>phc2sys</code> tool, while inter-system synchronization (across Ethernet interfaces) utilizes the <code>ptp4l</code> tool.</p>
<p>&lt;figure&gt;<img src="./resources/images/ptp4l.png" alt="PTP4L Setup" class="inline"/>&lt;figcaption&gt;PTP4L Setup.&lt;/figcaption&gt;&lt;/figure&gt;</p>
<p>It's also important to turn off NTP time synchronization service by using this command: </p><div class="fragment"><div class="line"> {$}</div>
<div class="line"> </div>
<div class="line">### Command Sets for PTP time Synchronization</div>
<div class="line"> </div>
<div class="line">Assuming the primary Ethernet interface is named `enp87s0` and the secondary interface is named `enp89s0`, the following commands are to be executed under root or with sudo:</div>
<div class="line"> </div>
<div class="line">**Primary System Commands:**</div>
<div class="line"> </div>
<div class="line">- **ptp4l:**</div>
<div class="line"> </div>
<div class="line">```shell</div>
<div class="line">ptp4l -i enp87s0 -m -f ./resources/gPTP.cfg</div>
</div><!-- fragment --><ul>
<li><b>phc2sys:</b></li>
</ul>
<div class="fragment"><div class="line">phc2sys -c enp87s0 -s CLOCK_REALTIME -w -O 0 -m -f ./resources/gPTP.cfg</div>
</div><!-- fragment --><p><b>Secondary System Commands:</b></p>
<ul>
<li><b>ptp4l:</b></li>
</ul>
<div class="fragment"><div class="line">ptp4l -i enp89s0 -s -m -f ./resources/gPTP.cfg</div>
</div><!-- fragment --><ul>
<li><b>phc2sys:</b></li>
</ul>
<div class="fragment"><div class="line">phc2sys -s enp89s0 -c CLOCK_REALTIME -O 0 -m -f ./resources/gPTP.cfg</div>
</div><!-- fragment --><p>The output of ptp4l on the primary system after running the above command should look like this:<br  />
</p>
<div class="fragment"><div class="line">ptp4l[13416.983]: selected /dev/ptp1 as PTP clock</div>
<div class="line">ptp4l[13417.002]: port 1: INITIALIZING to LISTENING on INIT_COMPLETE</div>
<div class="line">ptp4l[13417.003]: port 0: INITIALIZING to LISTENING on INIT_COMPLETE</div>
<div class="line">ptp4l[13420.445]: port 1: LISTENING to MASTER on ANNOUNCE_RECEIPT_TIMEOUT_EXPIRES</div>
<div class="line">ptp4l[13420.445]: selected local clock 844709.fffe.04f07f as best master</div>
<div class="line">ptp4l[13420.445]: assuming the grand master role</div>
</div><!-- fragment --><p>The output of ptp4l on the secondary system after running the above command should look like this:<br  />
</p>
<div class="fragment"><div class="line">ptp4l[14816.313]: selected /dev/ptp1 as PTP clock</div>
<div class="line">ptp4l[14816.328]: port 1: INITIALIZING to LISTENING on INIT_COMPLETE</div>
<div class="line">ptp4l[14816.328]: port 0: INITIALIZING to LISTENING on INIT_COMPLETE</div>
<div class="line">ptp4l[14820.220]: port 1: new foreign master 844709.fffe.04f07f-1</div>
<div class="line">ptp4l[14820.250]: selected local clock 844709.fffe.04eb0e as best master</div>
<div class="line">ptp4l[14822.220]: selected best master clock 844709.fffe.04f07f</div>
<div class="line">ptp4l[14822.220]: port 1: LISTENING to UNCALIBRATED on RS_SLAVE</div>
<div class="line">ptp4l[14822.650]: port 1: UNCALIBRATED to SLAVE on MASTER_CLOCK_SELECTED</div>
<div class="line">ptp4l[14823.275]: rms 158899 max 317730 freq -11742 +/- 3075 delay    14 +/-   0</div>
<div class="line">ptp4l[14824.276]: rms  820 max 1257 freq  -9067 +/- 1113 delay    14 +/-   0</div>
<div class="line">ptp4l[14825.277]: rms 1366 max 1436 freq  -6582 +/- 359 delay    13 +/-   0</div>
<div class="line">ptp4l[14826.278]: rms  866 max 1148 freq  -6099 +/-  34 delay    13 +/-   0</div>
<div class="line">ptp4l[14827.279]: rms  280 max  465 freq  -6364 +/- 102 delay    12 +/-   0</div>
<div class="line">ptp4l[14828.280]: rms   52 max   80 freq  -6666 +/-  65 delay    12 +/-   0</div>
<div class="line">ptp4l[14829.280]: rms   82 max   88 freq  -6805 +/-  21 delay    12 +/-   0</div>
<div class="line">ptp4l[14830.281]: rms   50 max   69 freq  -6829 +/-   3 delay    12 +/-   0</div>
<div class="line">ptp4l[14831.282]: rms   15 max   28 freq  -6811 +/-   7 delay    12 +/-   0</div>
<div class="line">ptp4l[14832.283]: rms    4 max    8 freq  -6795 +/-   5 delay    12 +/-   0</div>
<div class="line">ptp4l[14833.284]: rms    7 max   10 freq  -6783 +/-   3 delay    12 +/-   0</div>
<div class="line">ptp4l[14834.285]: rms    2 max    5 freq  -6788 +/-   3 delay    13 +/-   0</div>
<div class="line">ptp4l[14835.286]: rms    3 max    5 freq  -6793 +/-   3 delay    13 +/-   0</div>
</div><!-- fragment --><p>Please make it sure that the secondary sytem refers to the primary's precision time by checking if there is the **"new foreign master"** message in a log<br  />
 Note that the rms value should be decreasing with each line and should go down to single digits.</p>
<p>For user convenience, an automation Bash script is available in the scripts folder to facilitate ptp4l synchronization on both primary and secondary systems. Users simply need to update the <code>config.sh</code> file with relevant details such as the secondary system's address, username, and Ethernet address, among others. After these updates, run the scripts/run_ptp.sh script from the primary system. This script will automatically execute the ptp4l and phc2sys tools on both the primary and secondary systems in their respective modes. Note that the script requires the secondary system to enable passwordless SSH to execute ptp4l commands through the SSH interface.</p>
<p>Since the ptp4l and phc2sys tools require root privileges or sudo access, users need to provide their sudo password in the config.sh file. As an alternative, setting up passwordless sudo can streamline this process. Here's how to enable passwordless sudo:</p>
<p>Open a terminal and type <code>sudo visudo</code> to edit the sudoers file. Add the following line to the file at the end, replacing username with actual username:</p>
<div class="fragment"><div class="line">username ALL=(ALL) NOPASSWD: ALL</div>
</div><!-- fragment --><p>Save and close the file to apply the changes. This adjustment allows the automation scripts to run without requiring a sudo password each time, simplifying the setup for ptp4l and phc2sys synchronizations.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Synchronizing Display VBlanks</h2>
<p>Once the system clocks are synchronized, user can proceed to run the vsync test tool on both the primary and secondary systems. Installing and running the programs:<br  />
</p>
<ol type="1">
<li>Copy the release folder contents to both primary and secondary systems.<br  />
</li>
<li>On both systems, go to the directory where these files exist and set environment variable: export LD_LIBRARY_PATH=.<br  />
</li>
<li>On the primary system, run it as follows: <div class="fragment"><div class="line">./vsync_test -m pri -i [PTP_ETH_Interface]</div>
</div><!-- fragment --></li>
<li>On the secondary system, run it as follows: <div class="fragment"><div class="line">./vsync_test -m sec -i PTP_ETH_Interface -c [Primary_ETH_MAC_Addr] -d [sync after # us of drift]</div>
</div><!-- fragment --></li>
</ol>
<p>This program runs in server mode on the primary system and in client mode on the secondary system.</p>
<p>&lt;figure&gt;<img src="./resources/images/vsync_test.png" alt="VBlank synchronization setup" class="inline"/>&lt;figcaption&gt;VBlank synchronization setup.&lt;/figcaption&gt;&lt;/figure&gt;</p>
<p>If using PTP protocol to communicate between primary and secondary, there are some extra parameters required. The primary system must identify the PTP Interface (ex: enp176s0). The secondary system also requires its PTP interface as well as this port's ethernet MAC address. An example of PTP communication between primary and secondary looks like this: On the primary system, run it as follows: </p><div class="fragment"><div class="line">./vsync_test -m pri -i enp176s0</div>
</div><!-- fragment --><p> On the secondary system, run it as follows: </p><div class="fragment"><div class="line">./vsync_test -m sec -i enp176s0 -c 84:47:09:04:eb:0e</div>
</div><!-- fragment --><p>In the above examples, we were just sync'ing the secondary system once with the primary. However, due to reference clock differences, we see that there is a drift pretty much as soon as we have sync'd them. We also have another capability which allows us to resync as soon as it goes above a threshold. For example: On the primary system, run it as follows: </p><div class="fragment"><div class="line"> {/vsync_test}</div>
<div class="line">On the secondary system, run it as follows:</div>
<div class="line"> ```./vsync_test -m sec -i enp176s0 -c 84:47:09:04:eb:0e 100</div>
</div><!-- fragment --><p>In the above example, secondary system would sync with the primary once but after that it would constantly check to see if the drift is going above 100 us. As soon as it does, the secondary system would automatically resync with the primary. It is recommended to select a large number like 60 or 100 since if we use a smaller number, then we will be resyncing all the time. On the other hand, if we chose a really big number like 1000 us, then we are allowing the systems to get out of sync from each other for 1 ms. On a Tiger Lake system, 100 us difference is usually happening in around 60-70 seconds or about a minute. So this program would automatically resync with the primary every minute or so.</p>
<p>Similar to ptp4l, an automation script is provided to setup vsync primary and secondary on both systems. see ./scripts/run_vsync.sh. Make sure to update config.sh accordingly unless if it's already updated for run_ptp.sh.</p>
<p>Similar to ptp4l, For user convenience, an automation Bash script is available in the scripts folder to facilitate vsync synchronization on both primary and secondary systems. Users simply need to update the <code>config.sh</code> file with relevant details such as the secondary system's address, username, and Ethernet address, among others. After these updates, run the scripts/run_vsync.sh script from the primary system. This script will automatically copy vblank_sync to secondary under ~/.vblanksync directory and execute the vblank_sync tool on both the primary and secondary systems in their respective modes. Note that the script requires the secondary system to enable passwordless SSH to execute ptp4l commands through the SSH interface.</p>
<div class="fragment"><div class="line">./scripts/run_vsync.sh</div>
</div><!-- fragment --><p>The console will display logs from both systems, but each process, including ptp4l and phc2sys, will also generate its own separate log file. These files can be found in the ./logs directory at the root level.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Running vsync_test as a Regular User without sudo</h2>
<p>While the ptp synchronization section provides methods for configuring passwordless sudo, it may be preferable to operate without using sudo or root privileges. The <code>vsync_test</code> application, which requires access to protected system resources for memory-mapped I/O (MMIO) operations at <code>/sys/bus/pci/devices/0000:00:02.0/resource0</code>, can be configured to run under regular user permissions. This can be achieved by modifying system permissions either through direct file permission changes or by adjusting user group memberships. Note that the resource path might change in future versions of the kernel. The resource path can be verified by running the application with the <code>strace</code> tool in Linux as a regular user and checking for permission denied errors or by examining <code>/proc/processid/maps</code> for resource mappings.</p>
<h3><a class="anchor" id="autotoc_md30"></a>
Option 1: Modifying File Permissions</h3>
<p>Altering the file permissions to allow all users to read and write to the device resource removes the requirement for root access. This method should be used with caution as it can lower the security level of the system, especially in environments with multiple users or in production settings.</p>
<p>To change the permissions, the following command can be executed:</p>
<div class="fragment"><div class="line">sudo chmod o+rw /sys/bus/pci/devices/0000:00:02.0/resource0</div>
</div><!-- fragment --><p>This command adjusts the permissions to permit all users (o) read and write (rw) access to the specified resource.</p>
<h3><a class="anchor" id="autotoc_md31"></a>
Option 2: Configuring User Group Permissions and Creating a Persistent udev Rule</h3>
<p>A more secure method is to assign the resource to a specific user group, such as the <code>video</code> group, and add the user to that group. This method confines permissions to a controlled group of users. To ensure the changes persist after a reboot, a <code>udev</code> rule can be created.</p>
<h4><a class="anchor" id="autotoc_md32"></a>
Step 1: Add the Resource to the Video Group</h4>
<p>Change the group ownership of the resource file to the <code>video</code> group using the following command:</p>
<div class="fragment"><div class="line">sudo chgrp video /sys/bus/pci/devices/0000:00:02.0/resource0</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md33"></a>
Step 2: Modify Group Permissions</h4>
<p>Set the group permissions to allow read and write access with:</p>
<div class="fragment"><div class="line">sudo chmod g+rw /sys/bus/pci/devices/0000:00:02.0/resource0</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md34"></a>
Step 3: Add the User to the Video Group</h4>
<p>Add the user to the video group using this command (replace username with the actual user name):</p>
<div class="fragment"><div class="line">sudo usermod -a -G video username</div>
</div><!-- fragment --><p>Log out and log back in, or start a new session, for the group changes to take effect.</p>
<h4><a class="anchor" id="autotoc_md35"></a>
Step 4: Create a udev Rule for Persistent Permissions</h4>
<p>To make the permissions persist after reboot, create a <code>udev</code> rule by adding a new rule file in <code>/etc/udev/rules.d/</code>:</p>
<div class="fragment"><div class="line">echo &#39;ACTION==&quot;add&quot;, SUBSYSTEM==&quot;pci&quot;, KERNEL==&quot;0000:00:02.0&quot;, RUN+=&quot;/bin/chgrp video %S%p/resource0&quot;, RUN+=&quot;/bin/chmod 0660 %S%p/resource0&quot;&#39; | sudo tee /etc/udev/rules.d/99-vsync-access.rules</div>
</div><!-- fragment --><p>This rule ensures that the permissions are correctly set when the system boots.</p>
<h4><a class="anchor" id="autotoc_md36"></a>
Step 5: Reload udev Rules</h4>
<p>After creating the rule, reload the udev rules to apply them immediately without rebooting:</p>
<div class="fragment"><div class="line">sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger -s pci --action=add</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md37"></a>
Verifying the Changes</h4>
<p>After applying one of the above methods, confirm that the user has the necessary permissions by running the vsync_test application without elevated privileges. If the setup is correct, the application should run without requiring sudo or root access.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
Running ptp4l as a Regular User without sudo</h2>
<p>Similarly, the ptp4l command can be executed by a regular user. This can be done by either altering the permissions or modifying the group for <code>/dev/ptp0</code>, or by creating a udev rule to ensure persistent permissions.</p>
<div class="fragment"><div class="line">echo &#39;SUBSYSTEM==&quot;ptp&quot;, KERNEL==&quot;ptp0&quot;, GROUP=&quot;video&quot;, MODE=&quot;0660&quot;&#39; | sudo tee /etc/udev/rules.d/99-ptp-access.rules</div>
</div><!-- fragment --><p>Reload udev Rules</p>
<div class="fragment"><div class="line">sudo udevadm control --reload-rules &amp;&amp;  sudo udevadm trigger</div>
</div><!-- fragment --><p>However, <code>phc2sys</code> will still need to be run with root or sudo privileges as it involves modifying system time. Running it under a normal user account could be possible if permissions to update the system clock are granted to the application.</p>
<h1><a class="anchor" id="autotoc_md39"></a>
Debug Tools</h1>
<p>When performing debugging, it is helpful to have the following libraries installed:</p>
<div class="fragment"><div class="line">apt install -y intel-gpu-tools edid-decode</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md40"></a>
Debug Tool Usage</h2>
<p>When encountering unexpected behavior that requires additional debugging, the installed tools can assist in narrowing down the potential problem.</p>
<p><b><a href="https://cgit.freedesktop.org/xorg/app/intel-gpu-tools/">intel-gpu-tools</a></b> Provides tools to read and write to registers, it must be run as the root user. Example:</p>
<div class="fragment"><div class="line">intel_reg dump --all &gt; /tmp/reg_dump.txt</div>
<div class="line"> </div>
<div class="line"># output excerpt</div>
<div class="line">                    GEN6_RP_CONTROL (0x0000a024): 0x00000400</div>
<div class="line">Gen6 disabled</div>
<div class="line">                      GEN6_RPNSWREQ (0x0000a008): 0x150a8000</div>
<div class="line">               GEN6_RP_DOWN_TIMEOUT (0x0000a010): 0x00000000</div>
<div class="line">           GEN6_RP_INTERRUPT_LIMITS (0x0000a014): 0x00000000</div>
<div class="line">               GEN6_RP_UP_THRESHOLD (0x0000a02c): 0x00000000</div>
<div class="line">                      GEN6_RP_UP_EI (0x0000a068): 0x00000000</div>
<div class="line">                    GEN6_RP_DOWN_EI (0x0000a06c): 0x00000000</div>
<div class="line">             GEN6_RP_IDLE_HYSTERSIS (0x0000a070): 0x00000000</div>
<div class="line">                      GEN6_RC_STATE (0x0000a094): 0x00040000</div>
<div class="line">                    GEN6_RC_CONTROL (0x0000a090): 0x00040000</div>
<div class="line">           GEN6_RC1_WAKE_RATE_LIMIT (0x0000a098): 0x00000000</div>
<div class="line">           GEN6_RC6_WAKE_RATE_LIMIT (0x0000a09c): 0x00000000</div>
<div class="line">        GEN6_RC_EVALUATION_INTERVAL (0x0000a0a8): 0x00000000</div>
<div class="line">             GEN6_RC_IDLE_HYSTERSIS (0x0000a0ac): 0x00000019</div>
<div class="line">                      GEN6_RC_SLEEP (0x0000a0b0): 0x00000000</div>
<div class="line">                GEN6_RC1e_THRESHOLD (0x0000a0b4): 0x00000000</div>
<div class="line">                 GEN6_RC6_THRESHOLD (0x0000a0b8): 0x00000000</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">intel_reg read 0x00062400</div>
<div class="line">                PIPE_DDI_FUNC_CTL_C (0x00062400): 0x00000000 (disabled, no port, HDMI, 8 bpc, -VSync, -HSync, EDP A ON, x1)</div>
</div><!-- fragment --><p><b><a href="https://manpages.debian.org/unstable/edid-decode/edid-decode.1.en.html">edid-decode</a></b> is a tool used to parse the Extended Display Identification Data (EDID) from monitors and display devices. EDID contains metadata about the display's capabilities, such as supported resolutions, manufacturer, serial number, and other attributes.</p>
<p>To operate edid-decode, it is typically necessary to supply a binary EDID file or data. Here's an example of how to use it:</p>
<div class="fragment"><div class="line">cat /sys/class/drm/card0-HDMI-A-1/edid &gt; edid.bin</div>
<div class="line"> </div>
<div class="line"># run edid-decode to parse and display the information</div>
<div class="line">edid-decode edid.bin</div>
<div class="line"> </div>
<div class="line"># sample output</div>
<div class="line">Extracted contents:</div>
<div class="line">header:          00 ff ff ff ff ff ff 00</div>
<div class="line">serial number:   10 ac 64 a4 4c 30 30 32</div>
<div class="line">version:         01 03</div>
<div class="line">basic params:    80 34 20 78 2e</div>
<div class="line">chroma info:     c5 c4 a3 57 4a 9c 25 12 50 54</div>
<div class="line">established:     bf ef 80</div>
<div class="line">standard:        71 4f 81 00 81 40 81 80 95 00 a9 40 b3 00 01 01</div>
<div class="line">descriptor 1:    4d d0 00 a0 f8 70 3e 80 30 20 35 00 55 50 21 00 00 1a</div>
<div class="line">descriptor 2:    02 3a 80 18 71 38 2d 40 58 2c 45 00 55 50 21 00 00 1e</div>
<div class="line">descriptor 3:    00 00 00 ff 00 43 32 30 30 38 30 4e 50 30 0a 20 20 20</div>
<div class="line">descriptor 4:    00 00 00 fd 00 32 4b 1e 53 11 00 0a 20 20 20 20 20 20</div>
<div class="line">extensions:      01</div>
<div class="line">checksum:        1c</div>
<div class="line"> </div>
<div class="line">Manufacturer: DEL Model a464 Serial Number 808909324</div>
<div class="line">Made week 12 of 2008</div>
<div class="line">EDID version: 1.3</div>
<div class="line">Digital display</div>
<div class="line">Maximum image size: 52 cm x 32 cm</div>
<div class="line">Gamma: 2.20</div>
<div class="line">DPMS levels: Standby Suspend Off</div>
<div class="line">RGB color display</div>
<div class="line">First detailed timing is preferred timing</div>
<div class="line">Display x,y Chromaticity:</div>
<div class="line">  Red:   0.6396, 0.3300</div>
<div class="line">  Green: 0.2998, 0.5996</div>
<div class="line">  Blue:  0.1503, 0.0595</div>
<div class="line">  White: 0.3134, 0.3291</div>
<div class="line">Established timings supported:</div>
<div class="line">  720x400@70Hz</div>
<div class="line">  640x480@60Hz</div>
<div class="line">  640x480@67Hz</div>
<div class="line">  640x480@72Hz</div>
<div class="line">  640x480@75Hz</div>
<div class="line">  800x600@56Hz</div>
<div class="line">  800x600@60Hz</div>
<div class="line">  ...</div>
<div class="line">Standard timings supported:</div>
<div class="line">  1152x864@75Hz</div>
<div class="line">  1280x800@60Hz</div>
<div class="line">  1280x960@60Hz</div>
<div class="line">  ...</div>
<div class="line">Detailed mode: Clock 148.500 MHz, 509 mm x 286 mm</div>
<div class="line">               1920 2008 2052 2200 hborder 0</div>
<div class="line">               1080 1084 1089</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Nov 5 2024 23:25:18 for Software Genlock by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
